class o{constructor(t={}){this.survey=t.surveyData,this.customCSS=t.customCSS||"",this.onComplete=t.onComplete||(()=>{}),this.onClose=t.onClose||(()=>{}),this.autoClose=t.autoClose||0,this.container=null,this.token=t.token||"",this.responseToken=t.responseToken||"",this.surveyId=t.surveyId||"",this.userId=t.userId||"",this.extraInfo=t.extraInfo||"",this.branding=t.branding||!1,this.apiUrl="https://app.opineeo.com/api/survey/v0",this.i=0,this.done=!1,this.s=!1,this.r={},this.ot={},this.scopeClass=null,this.loading=!1,this.error=null}async mount(t){this.container=document.getElementById(t),this.container&&(this.injectCSS(),this.container.style.display="block",!this.survey&&this.token&&this.surveyId&&await this.fetchSurveyData(),this.token&&this.surveyId||(this.branding=!0),this.survey||(this.error="Survey not found"),this.initializeScopeClass(),this.addCustomStyles(),this.render(),["click","input"].forEach(t=>this.container.addEventListener(t,e=>this[`on${t[0].toUpperCase()}${t.slice(1)}`](e))))}async fetchSurveyData(){this.loading=!0,this.render();try{const t=`${this.apiUrl}?surveyId=${encodeURIComponent(this.surveyId)}`,e=await fetch(t,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`}});if(!e.ok)throw new Error((await e.json()).error||"Failed to fetch survey data");const s=await e.json(),i=s?.data;if(this.responseToken=i.responseToken,this.branding=i.branding,!s?.success||!i)throw new Error("Invalid survey data received");this.survey=i,i.style&&(this.customCSS=i.style)}catch(t){console.error("Error fetching survey data:",t),this.error=t.message||"Failed to load survey"}finally{this.loading=!1}}injectCSS(){if(document.getElementById("opineeo-style"))return;const t=document.createElement("style");t.id="opineeo-style",t.textContent=":root{--sv-primary-color:currentColor;--sv-secondary-bg:rgba(0,0,0,.1);--sv-secondary-border:rgba(0,0,0,.2);--sv-text-color:inherit}.sv{position:relative;display:flex;flex-direction:column;justify-content:space-between;background:transparent;color:inherit;margin:16px 0;padding:16px;min-width:300px;min-height:300px;font:inherit;overflow:hidden}.x{position:absolute;top:4px;right:4px;width:32px;height:32px;border:0;border-radius:50%;background:transparent;opacity:.7;cursor:pointer;font-size:24px;color:inherit;z-index:999}.x:hover{opacity:1}.body{padding:.5rem;margin-bottom:1rem;overflow:hidden;transition:opacity .3s ease}.qc{width:100%;height:100%;padding:0 4px}.qt{font-weight:600;margin-bottom:.5rem;font-size:18px}.qd{opacity:.8;margin-bottom:1rem;font-size:16px}.qs{margin-bottom:1rem;font-size:20px}.opts{margin-top:1.8rem;display:flex;flex-direction:column;align-items:flex-start}.req{color:#ef4444;font-size:1.2rem}.ft{padding:.5rem;display:flex;flex-direction:column}.nav{display:flex}.btn{display:flex;align-items:center;gap:.5rem;padding:.5rem 1rem;border-radius:6px;cursor:pointer;font:inherit;transition:all .2s ease}.btno{margin-right:.5rem;background:var(--sv-secondary-bg);border:1px solid var(--sv-secondary-border);color:var(--sv-text-color)}.btno:hover{background:rgba(0,0,0,.15);border-color:rgba(0,0,0,.3)}.btnp{border:0;background:var(--primary,var(--sv-primary-color));color:#fff}.btnp:hover{opacity:.9}.btn:disabled{opacity:.5;cursor:not-allowed}.spinner{animation:spin 1s linear infinite}.qtc{position:relative;overflow:hidden;min-height:200px;width:100%;height:auto}.qtc .qc{position:relative;width:100%;height:auto}.q-exit-right{animation:oR .3s ease-out forwards}.q-enter-right{animation:iR .4s ease-out forwards}.q-exit-left{animation:oL .3s ease-out forwards}.q-enter-left{animation:iL .4s ease-out forwards}.brand{margin-top:1rem;font-size:.75rem;opacity:.7}.brand a{color:inherit}.rad,.chk{display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem;cursor:pointer}.txt{width:100%;padding:.5rem;border:1px solid currentColor;border-radius:6px;font-size:16px;background:transparent;box-sizing:border-box;color:inherit;font-family:inherit}.stars{display:flex;justify-content:center;gap:.5rem}.star-btn{padding:.25rem;background:none;border:none;cursor:pointer;border-radius:50%;transition:all .2s ease;display:flex;align-items:center;justify-content:center;outline:0}.star-btn:hover{transform:scale(1.1)}.star-btn.star-sel{background-color:transparent}.star-svg{width:30px;height:30px;transition:all .2s ease}.star-btn:hover .star-svg{transform:scale(1.1)}.star-btn:not(.star-sel) .star-svg{opacity:.3}.ltxt{width:100%}.ta{width:100%;min-height:6rem;resize:none;border:1px solid currentColor;border-radius:6px;padding:.5rem;font-size:16px;background:transparent;box-sizing:border-box;color:inherit;font-family:inherit}.cc{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2rem;min-height:250px;position:relative}.ca{margin-bottom:2rem;position:relative}.sc-circle{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,#10b981,#059669);display:flex;align-items:center;justify-content:center;position:relative;animation:scaleIn .6s cubic-bezier(.68,-.55,.265,1.55);box-shadow:0 8px 25px rgba(16,185,129,.3)}.sc-circle::before{content:'';position:absolute;width:100px;height:100px;border-radius:50%;background:linear-gradient(135deg,#10b981,#059669);opacity:.3;animation:pulse 2s infinite}.sc-check{position:relative;width:24px;height:24px;transform:rotate(45deg);z-index:2}.cs{position:absolute;width:5px;height:25px;background-color:#fff;left:15px;top:-3px;border-radius:2px;animation:checkmarkStem .4s ease-in-out .3s both}.ck{position:absolute;width:15px;height:5px;background-color:#fff;left:4px;top:17px;border-radius:2px;animation:checkmarkKick .4s ease-in-out .5s both}@keyframes spin{to{transform:rotate(360deg)}}@keyframes oR{0%{transform:translateX(0);opacity:1}100%{transform:translateX(-100%);opacity:0}}@keyframes iR{0%{transform:translateX(100%);opacity:0}100%{transform:translateX(0);opacity:1}}@keyframes oL{0%{transform:translateX(0);opacity:1}100%{transform:translateX(100%);opacity:0}}@keyframes iL{0%{transform:translateX(-100%);opacity:0}100%{transform:translateX(0);opacity:1}}@keyframes p{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(6px)}}@keyframes a{0%{opacity:0;transform:scale(.3)}50%{transform:scale(1.1)}100%{opacity:1;transform:scale(1)}}@keyframes scaleIn{0%{transform:scale(0);opacity:0}100%{transform:scale(1);opacity:1}}@keyframes pulse{0%,100%{transform:scale(1);opacity:.3}50%{transform:scale(1.1);opacity:.1}}@keyframes checkmarkStem{0%{height:0}100%{height:25px}}@keyframes checkmarkKick{0%{width:0}100%{width:15px}}@media(max-width:400px){.sv{max-width:100%;margin:8px;padding:16px}.qt{font-size:16px}.star{font-size:20px}}",document.head.appendChild(t),this.t=1}initializeScopeClass(){if(!this.scopeClass){const t=this.survey?.id||"widget-"+Date.now()+"-"+Math.random().toString(36).slice(2,6);this.scopeClass="sv-scope-"+t.replace(/[^a-zA-Z0-9-_]/g,"-")}}addCustomStyles(){if(!this.customCSS)return;this.initializeScopeClass();const t="sv-custom-styles-"+this.scopeClass.replace("sv-scope-","");document.getElementById(t)?.remove();let e=this.customCSS;["sv","qt","qd","qc","opts","qs","btn","btno","btnp","rad","chk","txt","ta","stars","star-btn","star-svg","star-sel","x","body","ft","nav","brand","ltxt","req","ok","cc","ca","sc-circle","sc-check"].forEach(t=>e=e.replace(new RegExp(`\\.${t}\\b`,"g"),`.${this.scopeClass} .${t}`));const s=document.createElement("style");s.id=t,s.textContent=e,document.head.appendChild(s)}render(){if(!this.container)return;this.scopeClass&&(this.container.className=this.scopeClass);const t=this.survey?.questions||[],e=this.i>=t.length,s=this.loading?`<div class="cc"><div class="ca">${this.getSLoadingIcon()}</div>`:"",i=this.error||!this.survey&&!this.loading?`<div class="cc"><div class="ca">${this.getUnavailableIcon()}</div><p>Survey not available</p></div>`:"",r=t.length?(this.done||e?this.renderDone():`<div class="qtc">${this.renderQuestionCard(t[this.i])}</div>`)+`<div class="ft">${this.done?"":`<div class="nav">${this.i>0?`<button class="btn btno" data-a="prev">${this.getPrevArrowIcon()}</button>`:""}<button class="btn btnp" data-a="next" ${this.s?"disabled":""}>${this.s?this.getSpinnerIcon():this.i===t.length-1?this.getSendIcon():this.getNextArrowIcon()}</button></div>`}</div>`:"";this.container.innerHTML='<div class="sv"><button class="x" data-a="close">×</button>'+s+i+r+(this.branding?'<div class="brand">Powered by <a href="https://opineeo.com" target="_blank"><b>Opineeo</b></a></div></div>':""),this.focusInput()}getPrevArrowIcon(){return'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--secondary-foreground, rgba(0,0,0,.3))" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg>'}getNextArrowIcon(){return'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--primary-foreground, rgba(255,255,255,.7))" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>'}getSendIcon(){return'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--primary-foreground, rgba(255,255,255,.7))" stroke-width="2"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>'}getSpinnerIcon(){return'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--primary-foreground, rgba(255,255,255,.7))" stroke-width="2" class="spinner"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>'}getSLoadingIcon(){return'<div style="display: flex; align-items: center; justify-content: center; width: 80px; height: 80px; margin: 0 auto;">\n            <div style="width: 60px; height: 60px; border: 4px solid rgba(0,0,0,0.1); border-top: 4px solid var(--primary, #3b82f6); border-radius: 50%; animation: spin 1s linear infinite;"></div>\n        </div>'}getUnavailableIcon(){return'<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z"/><path d="M12 15h.01"/><path d="M12 7v4"/></svg>'}renderQuestionCard(t){return`<div class="body"><div class="qc"><h2 class="qt">${t.title}${t.required?' <span class="req">*</span>':""}</h2>${t.description&&"STATEMENT"!==t.format?`<p class="qd">${t.description}</p>`:""}<div class="opts">${this.renderQuestion(t)}</div></div></div>`}resp(t,e,s,i){const r={questionId:t,isOther:i},o=typeof e;return"string"===o?r.textValue=e:"number"===o?r.numberValue=e:"boolean"===o&&(r.booleanValue=e),null!=s&&(r.optionId=s),r}renderQuestion(t){const e=this.r[t.id];if("YES_NO"===t.format){const s=!0===e?.booleanValue?"yes":!1===e?.booleanValue?"no":null;return this.radioList(t.id,[{id:"yes",text:t.yesLabel||"Yes"},{id:"no",text:t.noLabel||"No"}],s)}if("SINGLE_CHOICE"===t.format){const s=e?.optionId;return t.options.map(e=>{const i=s===e.id;return`<label class="rad"><input type="radio" name="q_${t.id}" value="${e.id}" ${i?"checked":""} data-a="set" data-q="${t.id}"><span>${e.text}</span></label>`+(e.isOther?`<div class="other" ${i?"":"hidden"}><input class="txt" type="text" placeholder="Please specify…" value="${this.ot[t.id]||""}" data-a="other" data-q="${t.id}"></div>`:"")}).join("")}if("MULTIPLE_CHOICE"===t.format){const s=e?.optionId?e.optionId.split(","):[],i=s.some(e=>t.options.find(t=>t.id===e)?.isOther);return t.options.map(e=>{const r=s.includes(e.id);return`<label class="chk"><input type="checkbox" value="${e.id}" ${r?"checked":""} data-a="toggle" data-q="${t.id}"><span>${e.text}</span></label>`+(e.isOther?`<div class="other" ${i?"":"hidden"}><input class="txt" type="text" placeholder="Please specify…" value="${this.ot[t.id]||""}" data-a="other" data-q="${t.id}"></div>`:"")}).join("")}if("STAR_RATING"===t.format){const s=e?.numberValue||0;return`<div class="stars" data-q="${t.id}" data-a="stars">`+[1,2,3,4,5].map(t=>`<button class="star-btn${t<=s?" star-sel":""}" data-star="${t}" aria-label="${t} star"><svg class="star-svg" width="24" height="24" viewBox="0 0 24 24" fill="${t<=s?"#fbbf24":"none"}" stroke="${t<=s?"#fbbf24":"currentColor"}" stroke-width="2"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26 12,2"/></svg></button>`).join("")+"</div>"}return"LONG_TEXT"===t.format?`<div class="ltxt"><textarea class="ta" data-a="setText" data-q="${t.id}">${e?.textValue||""}</textarea></div>`:"STATEMENT"===t.format?`<p class="qs">${t.description||""}</p>`:'<p class="qd">Unsupported question type</p>'}radioList(t,e,s){return e.map(e=>`<label class="rad"><input type="radio" name="q_${t}" value="${e.id}" ${s===e.id?"checked":""} data-a="set" data-q="${t}"><span>${e.text}</span></label>`).join("")}renderDone(){return this.autoClose>0&&setTimeout(()=>this.close(),this.autoClose),'<div class="cc"><div class="ca"><div class="sc-circle"><div class="sc-check"><div class="cs"></div><div class="ck"></div></div></div></div></div>'}transitionToNext(){this.i<this.survey.questions.length-1&&this.transitionToQuestion(this.i+1,"right")}transitionToPrevious(){this.i>0&&this.transitionToQuestion(this.i-1,"left")}transitionToQuestion(t,e){if(!this.container)return;const s=this.container.querySelector(".qtc");if(!s)return this.i=t,void this.render();const i="right"===e?"q-exit-right":"q-exit-left",r="right"===e?"q-enter-right":"q-enter-left";s.classList.add(i),setTimeout(()=>{this.i=t;const e=this.survey.questions[this.i];e&&(s.innerHTML=this.renderQuestionCard(e),s.classList.remove(i),s.classList.add(r),setTimeout(()=>s.classList.remove(r),400),this.render(),this.focusInput())},300)}async handleSubmit(){this.s=!0,this.render();try{const t=await this.pack();if(this.token&&this.responseToken)try{const e=await fetch(this.apiUrl,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify(t)}),s=await e.json();e.ok||console.error("Failed to submit survey response: "+s.error)}catch(t){console.error("Submission error:",t)}this.onComplete(t),this.done=!0}catch(t){console.error("Submission error:",t)}finally{this.s=!1,this.render()}}onClick(t){if(!this.survey||!this.container)return;const e=t.target,s=e.dataset.a||e.closest("[data-a]")?.dataset.a;if(s){if("close"===s)return this.close();if("prev"===s)return this.transitionToPrevious();if("next"===s){const t=this.survey.questions[this.i];return this.isValidQuestion(t)?this.i===this.survey.questions.length-1?this.handleSubmit():this.transitionToNext():this.shake()}if("set"===s){const t=e.dataset.q||e.closest("[data-q]")?.dataset.q,s=this.survey.questions.find(e=>e.id===t),i=s?.options?.find(t=>t.id===e.value);return this.r[t]="YES_NO"===s?.format?this.resp(t,"yes"===e.value,void 0,!1):this.resp(t,void 0,e.value,!!i?.isOther),i?.isOther||delete this.ot[t],this.render()}if("toggle"===s){const t=e.dataset.q||e.closest("[data-q]")?.dataset.q,s=this.survey.questions.find(e=>e.id===t),i=s?.options?.find(t=>t.id===e.value),r=this.r[t]?.optionId?this.r[t].optionId.split(","):[],o=r.indexOf(e.value);o>-1?(r.splice(o,1),i?.isOther&&delete this.ot[t]):r.push(e.value);const n=r.some(t=>s?.options?.find(e=>e.id===t)?.isOther);return this.r[t]=this.resp(t,void 0,r.join(","),n),this.render()}if("stars"===s){const t=e.closest(".star-btn");if(!t)return;const s=e.closest("[data-q]").dataset.q;return this.r[s]=this.resp(s,+t.dataset.star,void 0,!1),this.render()}}}onInput(t){if(!this.survey||!this.container)return;const e=t.target,s=e.dataset.a;if(!s)return;const i=e.dataset.q;"other"===s&&(this.ot[i]=e.value),"setText"===s&&(this.r[i]=this.resp(i,e.value,void 0,!1))}shake(){if(!this.container)return;const t=this.container.querySelector(".qc");t&&(t.style.animation="p .25s ease",setTimeout(()=>t.style.animation="",250))}isValidQuestion(t){const e=this.r[t.id];return!t.required||e&&(!e.isOther||this.ot[t.id]&&""!==this.ot[t.id].trim())}focusInput(){if(!this.container||!this.survey||!this.survey.questions)return;const t=this.survey.questions[this.i];setTimeout(()=>{this.container&&("LONG_TEXT"===t?.format?this.container.querySelector(".ta"):this.container.querySelector(".other:not([hidden]) .txt"))?.focus()},30)}close(){this.destroy(),this.onClose(),this.container&&this.container.parentNode&&this.container.parentNode.removeChild(this.container)}destroy(){this.container&&["click","input"].forEach(t=>this.container.removeEventListener(t,e=>this[`on${t[0].toUpperCase()}${t.slice(1)}`](e))),this.container&&(this.container.innerHTML=""),this.container=null,this.survey=null,this.r={},this.ot={},this.i=0,this.done=!1,this.s=!1,this.loading=!1,this.error=null}async pack(){const t=Object.keys(this.r).map(t=>{const e=this.r[t],s=this.survey.questions.find(e=>e.id===t);let i=e.textValue||"",r=null;if(s)if("YES_NO"===s.format)"boolean"==typeof e.booleanValue&&(i=e.booleanValue?s.yesLabel||"Yes":s.noLabel||"No");else if("MULTIPLE_CHOICE"===s.format){const o=e.optionId.split(",").map(t=>t.trim()).filter(t=>!!t),n=Array.isArray(s.options)?s.options:[];r=o.map(t=>n.find(e=>e.id===t)).filter(t=>!!t).map(e=>{const s={optionId:e.id,textValue:e.text||"",isOther:e.isOther||!1};return e.isOther&&this.ot&&this.ot[t]&&(s.textValue=this.ot[t]),s}),i=""}else if("SINGLE_CHOICE"===s.format){const t=s.options.find(t=>t.id===e.optionId);i=t?t.text:""}e.isOther&&this.ot[t]&&"MULTIPLE_CHOICE"!==s.format&&(i=this.ot[t]);const o={...e,textValue:i,questionTitle:s?.title||"",questionFormat:s?.format||""};return"MULTIPLE_CHOICE"===s?.format&&r&&(o.answers=r),o}),e={responseToken:this.responseToken,surveyId:this.surveyId,responses:t};return this.userId&&(e.userId=this.userId),this.extraInfo&&(e.extraInfo=this.extraInfo),e}}window.initSurveyWidget=t=>new o(t),(()=>{if(!customElements.get("opineeo-survey")){class e extends HTMLElement{static get observedAttributes(){return["survey-id","token","auto-close","user-id","extra-info","custom-css","oncomplete","onclose","survey"]}constructor(){super(),this._id="opn-"+Math.random().toString(36).slice(2),this._widget=null,this._surveyData=void 0,this._customCSS=void 0}connectedCallback(){if(!this._mounted){const t=document.createElement("div");t.id=this._id,this.appendChild(t),this._mounted=!0}this._mount()}disconnectedCallback(){this._widget?.destroy?.(),this._widget=null}attributeChangedCallback(){this._mounted&&this._mount()}get surveyData(){return this._surveyData}set surveyData(t){this._surveyData=t,this._mounted&&this._mount()}get customCSS(){return this._customCSS}set customCSS(t){this._customCSS=t,this._mounted&&this._mount()}_mount(){const e=this.getAttribute("oncomplete"),s=this.getAttribute("onclose"),i=t(e),r=t(s);let n=null;const a=this.getAttribute("survey");if(a)try{n=JSON.parse(a)}catch(t){console.warn("Invalid JSON in survey attribute:",t)}const d={surveyId:this.getAttribute("survey-id")||"",token:this.getAttribute("token")||"",autoClose:+(this.getAttribute("auto-close")||0),userId:this.getAttribute("user-id")||"",extraInfo:""===this.getAttribute("extra-info"),surveyData:n||this._surveyData,customCSS:this.getAttribute("custom-css")||this._customCSS,onComplete:t=>{i?.(t,this),this.dispatchEvent(new CustomEvent("complete",{detail:t}))},onClose:()=>{r?.(this),this.dispatchEvent(new Event("close"));try{if(this._id&&this.isConnected&&this.querySelector){const t=this.querySelector(`#${this._id}`);t&&t.remove()}}catch(t){console.warn("Error removing survey container:",t)}}};this._widget=new o(d),this._widget.mount(this._id)}}customElements.define("opineeo-survey",e)}function t(t){if(!t)return null;let e=window;for(const s of t.split("."))e=e?.[s];return"function"==typeof e?e:null}})();